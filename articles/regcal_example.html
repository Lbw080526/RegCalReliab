<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>regcal_example • RegCalReliab</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="regcal_example">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RegCalReliab</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/regcal_example.html">regcal_example</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lbw080526/RegCalReliab/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>regcal_example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lbw080526/RegCalReliab/blob/main/vignettes/regcal_example.Rmd" class="external-link"><code>vignettes/regcal_example.Rmd</code></a></small>
      <div class="d-none name"><code>regcal_example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>RegCalReliab</strong> package provides a unified
framework for regression calibration under both external and internal
reliability study designs. External reliability studies collect
replicate measurements on a separate sample, while internal reliability
studies collect replicates within the main study cohort. In both
settings, regression calibration replaces the error-prone exposures with
their estimated conditional expectations, thereby correcting bias and
improving confidence interval coverage.</p>
<p>This document demonstrates the use of <strong>RegCalReliab</strong>
through simulation studies under a logistic regression model. We
generate data with two error-prone exposures (z1, z2) and two error-free
covariates (W1, W2), with a true odds ratio of 1.5 for each exposure.
Results are compared between naïve analyses (ignoring measurement error)
and regression calibration, highlighting the bias correction and
improved inference provided by the method.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lbw080526/RegCalReliab" class="external-link">RegCalReliab</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-simulation-for-external">Data Simulation for External<a class="anchor" aria-label="anchor" href="#data-simulation-for-external"></a>
</h2>
</div>
<div class="section level2">
<h2 id="setup">1. Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>In this section we load packages, fix the seed, and define helper
functions. We set the true slope
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
= log(1.5), corresponding to a true odds ratio (OR) of 1.5 for each
error-prone exposure.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; This is mgcv 1.9-3. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper for measurement error</span></span>
<span><span class="va">add_err</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True coefficient (on log-odds scale) and OR</span></span>
<span><span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">OR_true</span> <span class="op">=</span> <span class="fl">1.5</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="one-simulation-replicate-for-external-logistic">2. One simulation replicate for External Logistic<a class="anchor" aria-label="anchor" href="#one-simulation-replicate-for-external-logistic"></a>
</h2>
<p>A single call to simulate_once() generates one dataset and fits
regression calibration.</p>
<ul>
<li><p>The main study has 1500 subjects.</p></li>
<li><p>The external reliability study has 1500 subjects with 2, 3, or 4
replicates per subject (padded with NA).</p></li>
<li><p>Error-free covariates W1 (continuous) and W2 (binary) are
included.</p></li>
<li><p>The outcome Y is generated under a logistic model with slope
log(1.5) for both exposures.</p></li>
<li><p>We call RC_ExReliab() with link = “logistic” to obtain both naïve
and corrected estimates.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_once</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ---- True covariates ----</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/rmvn.html" class="external-link">rmvn</a></span><span class="op">(</span><span class="fl">3000</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Error-free covariates (W1 = continuous, W2 = binary)</span></span>
<span>  <span class="va">W1_main</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1500</span><span class="op">)</span></span>
<span>  <span class="va">W2_main</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1500</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">W1_rep</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1500</span><span class="op">)</span></span>
<span>  <span class="va">W2_rep</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1500</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Main study error-prone Z ----</span></span>
<span>  <span class="va">z.main</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1500</span><span class="op">*</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1500</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z.main</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"z1"</span>,<span class="st">"z2"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- External replicates for Z ----</span></span>
<span>  <span class="va">z1_rep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z1_rep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"z1_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">z2_rep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z2_rep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"z2_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># ---- Outcome ----</span></span>
<span>  <span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.3</span> <span class="op">+</span> <span class="va">beta</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1500</span>, <span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">W1_main</span> <span class="op">-</span> <span class="fl">0.3</span><span class="op">*</span><span class="va">W2_main</span><span class="op">)</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1500</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">main_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>    z1 <span class="op">=</span> <span class="va">z.main</span><span class="op">[</span>, <span class="st">"z1"</span><span class="op">]</span>,</span>
<span>    z2 <span class="op">=</span> <span class="va">z.main</span><span class="op">[</span>, <span class="st">"z2"</span><span class="op">]</span>,</span>
<span>    W1 <span class="op">=</span> <span class="va">W1_main</span>,</span>
<span>    W2 <span class="op">=</span> <span class="va">W2_main</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rep_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">z1_rep</span>, <span class="va">z2_rep</span>, W1 <span class="op">=</span> <span class="va">W1_rep</span>, W2 <span class="op">=</span> <span class="va">W2_rep</span>, check.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Regression Calibration ----</span></span>
<span>  <span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="../reference/RC_ExReliab.html">RC_ExReliab</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fu">z1</span><span class="op">(</span><span class="va">z1_1</span>, <span class="va">z1_2</span>, <span class="va">z1_3</span>, <span class="va">z1_4</span><span class="op">)</span> <span class="op">+</span> <span class="fu">z2</span><span class="op">(</span><span class="va">z2_1</span>, <span class="va">z2_2</span>, <span class="va">z2_3</span>, <span class="va">z2_4</span><span class="op">)</span> <span class="op">+</span> <span class="va">W1</span> <span class="op">+</span> <span class="va">W2</span>,</span>
<span>    main_data <span class="op">=</span> <span class="va">main_data</span>,</span>
<span>    rep_data <span class="op">=</span> <span class="va">rep_data</span>,</span>
<span>    link <span class="op">=</span> <span class="st">"logistic"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulation-replicate">3. 100 simulation replicate<a class="anchor" aria-label="anchor" href="#simulation-replicate"></a>
</h2>
<p>We repeat the entire simulation 100 times. Each run returns a results
object containing two tables:</p>
<p><strong>uncorrected</strong> = naïve logistic regression ignoring
measurement error.</p>
<p><strong>corrected</strong> = regression calibration estimates
adjusted for error.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">results_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">B</span>, <span class="fu">simulate_once</span><span class="op">(</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract naive + corrected tables</span></span>
<span><span class="va">naive_tabs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">uncorrected</span><span class="op">)</span></span>
<span><span class="va">corrected_tabs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">corrected</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="average-estimates-across-simulations">4. Average estimates across simulations<a class="anchor" aria-label="anchor" href="#average-estimates-across-simulations"></a>
</h2>
<p>We compute the Monte Carlo average of the parameter estimates across
the 100 runs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_naive</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="va">naive_tabs</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span></span>
<span><span class="va">avg_corrected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="va">corrected_tabs</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAverage Naive Logistic Estimates (B = "</span>, <span class="va">B</span>, <span class="st">"):\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Naive Logistic Estimates (B = 100):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">avg_naive</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Estimate Std. Error   z value Pr(&gt;|z|)      OR  CI.low CI.high</span></span>
<span><span class="co">#&gt; (Intercept) -2.42815    0.10346 -23.48130  0.00000 0.08867 0.07247 0.10850</span></span>
<span><span class="co">#&gt; z1           0.31217    0.07817   3.98303  0.00788 1.37202 1.17689 1.59956</span></span>
<span><span class="co">#&gt; z2           0.30522    0.07817   3.90866  0.00644 1.36085 1.16754 1.58622</span></span>
<span><span class="co">#&gt; W1           0.48754    0.09118   5.34146  0.00003 1.63443 1.36664 1.95482</span></span>
<span><span class="co">#&gt; W2          -0.29440    0.17911  -1.63803  0.20679 0.75665 0.53294 1.07444</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAverage Corrected Logistic Estimates (B = "</span>, <span class="va">B</span>, <span class="st">"):\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Corrected Logistic Estimates (B = 100):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">avg_corrected</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Estimate Std. Error   z value Pr(&gt;|z|)      OR  CI.low CI.high</span></span>
<span><span class="co">#&gt; (Intercept) -2.42815    0.10358 -23.46051  2.00000 0.08867 0.07245 0.10853</span></span>
<span><span class="co">#&gt; z1           0.40940    0.11609   3.52319  0.02041 1.51921 1.20951 1.90864</span></span>
<span><span class="co">#&gt; z2           0.39907    0.11638   3.43776  0.01553 1.50019 1.19418 1.88504</span></span>
<span><span class="co">#&gt; W1           0.48707    0.09112   5.35650  0.00003 1.63355 1.36619 1.95351</span></span>
<span><span class="co">#&gt; W2          -0.29554    0.17953  -1.64100  1.76609 0.75584 0.53191 1.07419</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="coverage-rate-cr-calculation">5. Coverage-rate (CR) calculation<a class="anchor" aria-label="anchor" href="#coverage-rate-cr-calculation"></a>
</h2>
<p>Finally, we evaluate whether the true OR = 1.5 lies within the 95%
confidence intervals.</p>
<ul>
<li><p>Coverage is computed as the percentage of simulation replicates
whose CI covers the true OR.</p></li>
<li><p>Good coverage (~95%) indicates that the variance estimator is
accurate.</p></li>
<li><p>Naïve estimates typically show attenuation bias and poor
coverage, while corrected estimates should recover the true slope with
coverage close to the nominal level.</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inside_ci</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">tab</span>, <span class="va">i</span>, <span class="va">truth</span> <span class="op">=</span> <span class="va">OR_true</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ci</span> <span class="op">=</span> <span class="va">tab</span><span class="op">[</span><span class="va">i</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CI.low"</span>, <span class="st">"CI.high"</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">ci</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">truth</span> <span class="op">&amp;&amp;</span> <span class="va">truth</span> <span class="op">&lt;=</span> <span class="va">ci</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">row_z1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">avg_naive</span><span class="op">)</span> <span class="op">==</span> <span class="st">"z1"</span><span class="op">)</span></span>
<span><span class="va">row_z2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">avg_naive</span><span class="op">)</span> <span class="op">==</span> <span class="st">"z2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coverage</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">tab_list</span>, <span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">tab_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tab</span><span class="op">)</span> <span class="fu">inside_ci</span><span class="op">(</span><span class="va">tab</span>, <span class="va">row</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cov_z1_naive</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">naive_tabs</span>, <span class="va">row_z1</span><span class="op">)</span></span>
<span><span class="va">cov_z1_corr</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">corrected_tabs</span>, <span class="va">row_z1</span><span class="op">)</span></span>
<span><span class="va">cov_z2_naive</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">naive_tabs</span>, <span class="va">row_z2</span><span class="op">)</span></span>
<span><span class="va">cov_z2_corr</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">corrected_tabs</span>, <span class="va">row_z2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCoverage of TRUE OR = 1.5 for error-prone exposure z1:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coverage of TRUE OR = 1.5 for error-prone exposure z1:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Naive                 : %5.1f %%\n"</span>, <span class="va">cov_z1_naive</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Naive                 :  77.0 %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Regression Calibration: %5.1f %%\n"</span>, <span class="va">cov_z1_corr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Regression Calibration:  92.0 %</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCoverage of TRUE OR = 1.5 for error-prone exposure z2:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coverage of TRUE OR = 1.5 for error-prone exposure z2:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Naive                 : %5.1f %%\n"</span>, <span class="va">cov_z2_naive</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Naive                 :  76.0 %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Regression Calibration: %5.1f %%\n"</span>, <span class="va">cov_z2_corr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Regression Calibration:  96.0 %</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-simulation-for-internal">Data Simulation for Internal<a class="anchor" aria-label="anchor" href="#data-simulation-for-internal"></a>
</h2>
</div>
<div class="section level2">
<h2 id="setup-1">1. Setup<a class="anchor" aria-label="anchor" href="#setup-1"></a>
</h2>
<p>In this section we load packages, fix the seed, and define helper
functions. We set the true slope
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
= log(1.5), corresponding to a true odds ratio (OR) of 1.5 for each
error-prone exposure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper for measurement error</span></span>
<span><span class="va">add_err</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v</span>, <span class="va">sd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="va">v</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># True slope and OR</span></span>
<span><span class="va">beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">OR_true</span> <span class="op">=</span> <span class="fl">1.5</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="one-simulation-replicate-for-internal-logistic">2. One simulation replicate for Internal Logistic<a class="anchor" aria-label="anchor" href="#one-simulation-replicate-for-internal-logistic"></a>
</h2>
<p>Here we generate one dataset with both main study and reliability
information. Replicates are included in the same main_data frame.</p>
<ul>
<li><p>x1, x2 are error-prone exposures with 1–4 replicates</p></li>
<li><p>W1 is a continuous error-free covariate</p></li>
<li><p>W2 is a binary covariate, dependent on x1</p></li>
<li><p>Y is generated from a logistic model with slope log(1.5)</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_once</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ---- True covariates ----</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/rmvn.html" class="external-link">rmvn</a></span><span class="op">(</span><span class="fl">3000</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.3</span>,<span class="fl">0.2</span>,</span>
<span>                           <span class="fl">0.3</span>,<span class="fl">1</span>,<span class="fl">0.5</span>,</span>
<span>                           <span class="fl">0.2</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Binary W2 depends on x1</span></span>
<span>  <span class="va">w2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">0.3</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Error-free covariates</span></span>
<span>  <span class="va">W</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, <span class="va">w2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"W1"</span>, <span class="st">"W2"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Replicate design ----</span></span>
<span>  <span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1500</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">500</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">400</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">600</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Replicates for z1</span></span>
<span>  <span class="va">z1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"z1_"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Replicates for z2</span></span>
<span>  <span class="va">z2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1500</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1501</span><span class="op">:</span><span class="fl">2000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2001</span><span class="op">:</span><span class="fl">2400</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu">add_err</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2401</span><span class="op">:</span><span class="fl">3000</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z2</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"z2_"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Outcome ----</span></span>
<span>  <span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.65</span> <span class="op">+</span> <span class="va">beta</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">beta</span><span class="op">*</span><span class="va">w2</span><span class="op">)</span></span>
<span>  <span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">3000</span>, <span class="fl">1</span>, <span class="va">p</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Main data with outcome, replicates, covariates ----</span></span>
<span>  <span class="va">main_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">z1</span>, <span class="va">z2</span>, <span class="va">W</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ---- Regression calibration ----</span></span>
<span>  <span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="../reference/RC_InReliab.html">RC_InReliab</a></span><span class="op">(</span></span>
<span>    formula   <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fu">myz1</span><span class="op">(</span><span class="va">z1_1</span>, <span class="va">z1_2</span>, <span class="va">z1_3</span>, <span class="va">z1_4</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="fu">myz2</span><span class="op">(</span><span class="va">z2_1</span>, <span class="va">z2_2</span>, <span class="va">z2_3</span>, <span class="va">z2_4</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="va">W1</span> <span class="op">+</span> <span class="va">W2</span>,</span>
<span>    main_data <span class="op">=</span> <span class="va">main_data</span>,</span>
<span>    link      <span class="op">=</span> <span class="st">"logistic"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulation-replicate-1">3. 100 simulation replicate<a class="anchor" aria-label="anchor" href="#simulation-replicate-1"></a>
</h2>
<p>We repeat the entire simulation 100 times. Each run returns a results
object containing two tables:</p>
<p><strong>uncorrected</strong> = naïve logistic regression ignoring
measurement error.</p>
<p><strong>corrected</strong> = regression calibration estimates
adjusted for error.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">results_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">B</span>, <span class="fu">simulate_once</span><span class="op">(</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect naïve + corrected tables</span></span>
<span><span class="va">naive_tabs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">uncorrected</span><span class="op">)</span></span>
<span><span class="va">corrected_tabs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">corrected</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="average-estimates-across-simulations-1">4. Average estimates across simulations<a class="anchor" aria-label="anchor" href="#average-estimates-across-simulations-1"></a>
</h2>
<p>We compute the Monte Carlo average of the parameter estimates across
the 100 runs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_naive</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="va">naive_tabs</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span></span>
<span><span class="va">avg_corrected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="va">corrected_tabs</span><span class="op">)</span> <span class="op">/</span> <span class="va">B</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAverage Naive Logistic Estimates (B = "</span>, <span class="va">B</span>, <span class="st">"):\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Naive Logistic Estimates (B = 100):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">avg_naive</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Estimate Std. Error   z value Pr(&gt;|z|)      OR  CI.low CI.high</span></span>
<span><span class="co">#&gt; (Intercept) -2.46347    0.07564 -32.57857  0.00000 0.08536 0.07362 0.09896</span></span>
<span><span class="co">#&gt; myz1         0.32896    0.05891   5.58205  0.00001 1.39137 1.23960 1.56175</span></span>
<span><span class="co">#&gt; myz2         0.31140    0.06348   4.90541  0.00038 1.36817 1.20808 1.54949</span></span>
<span><span class="co">#&gt; W1           0.45731    0.07129   6.41244  0.00000 1.58342 1.37684 1.82102</span></span>
<span><span class="co">#&gt; W2           0.44009    0.12598   3.49568  0.01636 1.56768 1.22472 2.00674</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAverage Corrected Logistic Estimates (B = "</span>, <span class="va">B</span>, <span class="st">"):\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average Corrected Logistic Estimates (B = 100):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">avg_corrected</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Estimate Std. Error   z value Pr(&gt;|z|)      OR  CI.low CI.high</span></span>
<span><span class="co">#&gt; (Intercept) -2.46506    0.07559 -32.62875  2.00000 0.08522 0.07352 0.09880</span></span>
<span><span class="co">#&gt; myz1         0.40418    0.07632   5.29511  0.00003 1.50144 1.29271 1.74396</span></span>
<span><span class="co">#&gt; myz2         0.39760    0.08593   4.62977  0.00093 1.49393 1.26225 1.76824</span></span>
<span><span class="co">#&gt; W1           0.40044    0.07559   5.29969  0.00005 1.49629 1.29017 1.73539</span></span>
<span><span class="co">#&gt; W2           0.41099    0.12687   3.24107  0.02646 1.52313 1.18781 1.95316</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="coverage-rate-cr-calculation-1">5. Coverage-rate (CR) calculation<a class="anchor" aria-label="anchor" href="#coverage-rate-cr-calculation-1"></a>
</h2>
<p>Finally, we evaluate whether the true OR = 1.5 lies within the 95%
confidence intervals.</p>
<ul>
<li><p>Coverage is computed as the percentage of simulation replicates
whose CI covers the true OR.</p></li>
<li><p>Good coverage (~95%) indicates that the variance estimator is
accurate.</p></li>
<li><p>Naïve estimates typically show attenuation bias and poor
coverage, while corrected estimates should recover the true slope with
coverage close to the nominal level.</p></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inside_ci</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">tab</span>, <span class="va">i</span>, <span class="va">truth</span> <span class="op">=</span> <span class="va">OR_true</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ci</span> <span class="op">=</span> <span class="va">tab</span><span class="op">[</span><span class="va">i</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CI.low"</span>, <span class="st">"CI.high"</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">ci</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">truth</span> <span class="op">&amp;&amp;</span> <span class="va">truth</span> <span class="op">&lt;=</span> <span class="va">ci</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">row_z1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">avg_naive</span><span class="op">)</span> <span class="op">==</span> <span class="st">"myz1"</span><span class="op">)</span></span>
<span><span class="va">row_z2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">avg_naive</span><span class="op">)</span> <span class="op">==</span> <span class="st">"myz2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coverage</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">tab_list</span>, <span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">tab_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tab</span><span class="op">)</span> <span class="fu">inside_ci</span><span class="op">(</span><span class="va">tab</span>, <span class="va">row</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cov_z1_naive</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">naive_tabs</span>, <span class="va">row_z1</span><span class="op">)</span></span>
<span><span class="va">cov_z1_corr</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">corrected_tabs</span>, <span class="va">row_z1</span><span class="op">)</span></span>
<span><span class="va">cov_z2_naive</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">naive_tabs</span>, <span class="va">row_z2</span><span class="op">)</span></span>
<span><span class="va">cov_z2_corr</span> <span class="op">=</span> <span class="fu">coverage</span><span class="op">(</span><span class="va">corrected_tabs</span>, <span class="va">row_z2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCoverage of TRUE OR = 1.5 for error-prone exposure z1:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coverage of TRUE OR = 1.5 for error-prone exposure z1:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Naive                 : %5.1f %%\n"</span>, <span class="va">cov_z1_naive</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Naive                 :  73.0 %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Regression Calibration: %5.1f %%\n"</span>, <span class="va">cov_z1_corr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Regression Calibration:  96.0 %</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCoverage of TRUE OR = 1.5 for error-prone exposure z2:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coverage of TRUE OR = 1.5 for error-prone exposure z2:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Naive                 : %5.1f %%\n"</span>, <span class="va">cov_z2_naive</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Naive                 :  70.0 %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  • Regression Calibration: %5.1f %%\n"</span>, <span class="va">cov_z2_corr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   • Regression Calibration:  92.0 %</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This document illustrates the use of the RegCalReliab package for
regression calibration under measurement error in logistic regression
models. Two study designs are demonstrated:</p>
<ul>
<li><p>External reliability studies, where replicate measurements are
collected on a separate sample.</p></li>
<li><p>Internal reliability studies, where replicates are collected
within the main study.</p></li>
</ul>
<p>In both cases, we simulate data with two error-prone exposures (z1,
z2) and two error-free covariates (W1, W2). The true odds ratio for each
exposure is set to 1.5.</p>
<p>Key findings from the simulations:</p>
<ul>
<li><p>Naïve logistic regression, which ignores measurement error, shows
attenuation bias (estimates biased toward the null) and poor confidence
interval coverage.</p></li>
<li><p>Regression calibration corrects for the bias, yielding average
estimates closer to the true odds ratio.</p></li>
<li><p>Coverage probabilities of the 95% confidence intervals for
regression calibration are close to the nominal level (~ 95%),
indicating that the method recovers valid inference under both external
and internal reliability designs.</p></li>
</ul>
<p>Overall, the document demonstrates that regression calibration is an
effective and practical method for addressing measurement error in
regression models, and the RegCalReliab package provides a unified
framework for implementation in both external and internal reliability
studies.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yu Lu, Bowen Liu, Molin Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
